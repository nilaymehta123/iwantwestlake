!function(e){function t(t,i){e.ajax({dataType:"json",type:"POST",url:window.ajaxurl,data:{action:"vc_media_editor_add_image",filters:window.vc_selectedFilters,ids:t,vc_inline:!0}}).done(function(t){var a,r,l,o;if("function"==typeof i){for(a=[],l=[],o=0;o<t.data.ids.length;o++)r=n.model.Attachment.get(t.data.ids[o]),l.push(r.fetch()),a.push(r);e.when.apply(e,l).done(function(){i(a)})}}).fail(function(t){e(".media-modal-close").click(),window.vc&&window.vc.active_panel&&window.i18nLocale&&window.i18nLocale.error_while_saving_image_filtered&&vc.active_panel.showMessage(window.i18nLocale.error_while_saving_image_filtered,"error"),window.console&&window.console.error&&window.console.error(t)}).always(function(){e(".media-modal").removeClass("processing-media")})}function i(t){var i,a,n;return n=e(".media-frame:visible [data-vc-preview-image-filter="+t+"]"),n.length?(i=e(".media-frame:visible .attachment-info .thumbnail-image").eq(-1),a=i.find("img"),i.addClass("loading"),a.data("original-src")||a.data("original-src",a.attr("src")),n.val().length?void e.ajax({type:"POST",dataType:"json",url:window.ajaxurl,data:{action:"vc_media_editor_preview_image",filter:n.val(),attachment_id:t,preferred_size:window.getUserSetting("imgsize","medium")}}).done(function(e){e.success&&e.data.src.length&&a.attr("src",e.data.src)}).fail(function(e,t,i){window.console&&window.console.error&&window.console.error("Filter preview failed:",t,i)}).always(function(){i.removeClass("loading")}):(a.attr("src",a.data("original-src")),void i.removeClass("loading"))):void 0}var a,n=wp.media,r=n.featuredImage.set,l=n.editor.send.attachment,o=i18nLocale,d={};a=_.extend(n.view.AttachmentCompat.prototype.render),n.view.AttachmentCompat.prototype.render=function(){var t,n=this;return t=this.model.get("id"),a.call(this),_.defer(function(){var a,r,l,o,d;a=n.controller.$el.find(".attachment-info"),d=n.controller.$el.find("[data-vc-preview-image-filter]"),a.length&&d.length&&(o=d.parent().find(".vc-filter-label").text(),r='<label class="setting vc-image-filter-setting">',r+='<span class="name">'+o+"</span>",r+=d[0].outerHTML,r+="</label>",a.before(r),d.parents("tr").remove()),"undefined"!=typeof window.vc_selectedFilters&&"undefined"!=typeof window.vc_selectedFilters[t]&&(l=e(".media-frame:visible [data-vc-preview-image-filter="+t+"]"),l.length&&l.val(window.vc_selectedFilters[t]).change()),i(t)}),this},n.editor.send.attachment=function(e,i){function a(t){var i=t.pop().attributes;l(e,i).done(function(e){n.editor.insert(e)})}t([i.id],a)},n.featuredImage.set=function(t){var i=[t];-1!==t?e.ajax({type:"POST",url:window.ajaxurl,data:{action:"vc_media_editor_add_image",filters:window.vc_selectedFilters,ids:i}}).done(function(e){var i;!0===e.success&&e.data.ids.length?(i=e.data.ids.pop(),r(i)):r(t)}).fail(function(){r(t)}):r(t)},n.controller.VcSingleImage=n.controller.FeaturedImage.extend({defaults:_.defaults({id:"vc_single-image",filterable:"uploaded",multiple:!1,toolbar:"vc_single-image",title:o.set_image,priority:60,syncSelection:!1},n.controller.Library.prototype.defaults),updateSelection:function(){{var e,t=this.get("selection"),i=n.vc_editor.getData();this.get("library")}"undefined"!=typeof i&&""!==i&&-1!==i&&(e=_.map(i.toString().split(/,/),function(e){var t=n.model.Attachment.get(e);return t.fetch(),t})),t.reset(e)}}),n.controller.VcGallery=n.controller.VcSingleImage.extend({defaults:_.defaults({id:"vc_gallery",title:o.add_images,toolbar:"main-insert",filterable:"uploaded",library:n.query({type:"image"}),multiple:"add",editable:!0,priority:60,syncSelection:!1},n.controller.Library.prototype.defaults)}),n.VcSingleImage={getData:function(){return this.$hidden_ids.val()},set:function(t){return this.$img_ul.html(_.template(e("#vc_settings-image-block").html(),t)),this.$clear_button.show(),this.$hidden_ids.val(t.id).trigger("change"),!1},frame:function(t){return window.vc_selectedFilters={},this.element=t,this.$button=e(this.element),this.$block=this.$button.closest(".edit_form_line"),this.$hidden_ids=this.$block.find(".gallery_widget_attached_images_ids"),this.$img_ul=this.$block.find(".gallery_widget_attached_images_list"),this.$clear_button=this.$img_ul.next(),this._frame?this._frame:(this._frame=n({state:"vc_single-image",states:[new n.controller.VcSingleImage]}),this._frame.on("toolbar:create:vc_single-image",function(e){this.createSelectToolbar(e,{text:o.set_image,close:!1})},this._frame),this._frame.state("vc_single-image").on("select",this.select),this._frame)},select:function(){var e=this.get("selection");vc.events.trigger("click:media_editor:add_image",e,"single")}},n.view.MediaFrame.VcGallery=n.view.MediaFrame.Post.extend({createStates:function(){this.states.add([new n.controller.VcGallery])},bindHandlers:function(){n.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("toolbar:create:main-insert",this.createToolbar,this);var e={content:{embed:"embedContent","edit-selection":"editSelectionContent"},toolbar:{"main-insert":"mainInsertToolbar"}};_.each(e,function(e,t){_.each(e,function(e,i){this.on(t+":render:"+i,this[e],this)},this)},this)},mainInsertToolbar:function(e){var t=this;this.selectionStatusToolbar(e),e.set("insert",{style:"primary",priority:80,text:o.add_images,requires:{selection:!0},click:function(){var e=t.state(),i=e.get("selection");vc.events.trigger("click:media_editor:add_image",i,"gallery"),e.trigger("insert",i).reset()}})}}),n.vc_editor=_.clone(n.editor),_.extend(n.vc_editor,{$vc_editor_element:null,getData:function(){var e=n.vc_editor.$vc_editor_element,t=e.closest(".edit_form_line"),i=t.find(".gallery_widget_attached_images_ids");return i.val()},insert:function(t){var i=n.vc_editor.$vc_editor_element,a=i.closest(".edit_form_line"),r=a.find(".gallery_widget_attached_images_ids"),l=a.find(".gallery_widget_attached_images_list"),o="";_.each(t,function(t){o+=_.template(e("#vc_settings-image-block").html(),t)}),r.val(_.map(t,function(e){return e.id}).join(",")).trigger("change"),l.html(o)},open:function(e){var t;return e=this.id(e),t=this.get(e),t||(t=this.add(e)),window.vc_selectedFilters={},t.open()},add:function(e,t){var i=this.get(e);return i?i:d[e]?d[e]:i=d[e]=new n.view.MediaFrame.VcGallery(_.defaults(t||{},{state:"vc_gallery",title:o.add_images,library:{type:"image"},multiple:!0}))},init:function(){e("body").unbind("click.vcGalleryWidget").on("click.vcGalleryWidget",".gallery_widget_add_images",function(t){t.preventDefault();var i=e(this),a="visual-composer";return n.vc_editor.$vc_editor_element=e(this),"true"===i.attr("use-single")?void n.VcSingleImage.frame(this).open("vc_editor"):(i.blur(),void n.vc_editor.open(a))})}}),_.bindAll(n.vc_editor,"open"),e(document).ready(function(){n.vc_editor.init()}),vc.events.on("click:media_editor:add_image",function(i,a){function r(t){var r,l;switch(r=_.map(t,function(e){return e.attributes}),i.reset(r),l=_.map(i.models,function(e){return e.attributes}),"undefined"==typeof a&&(a=""),a){case"gallery":n.vc_editor.insert(l);break;case"single":n.VcSingleImage.set(l[0])}e(".media-modal").removeClass("processing-media"),e(".media-modal-close").click()}var l;l=[],e(".media-modal").addClass("processing-media"),i.each(function(e){l.push(e.get("id"))}),t(l,r)}),e("body").on("change","[data-vc-preview-image-filter]",function(){var t;t=e(this).data("vcPreviewImageFilter"),"undefined"==typeof window.vc_selectedFilters&&(window.vc_selectedFilters={}),window.vc_selectedFilters[t]=e(this).val(),i(t)})}(jQuery);