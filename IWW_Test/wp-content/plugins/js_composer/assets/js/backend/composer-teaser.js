!function(e){wp.media.controller.VcTeaserCustomImage=wp.media.controller.FeaturedImage.extend({defaults:_.defaults({id:"vc_teaser-custom-image",filterable:"uploaded",multiple:!1,toolbar:"vc_single-image",title:i18nLocale.set_image,priority:60,syncSelection:!1},wp.media.controller.Library.prototype.defaults),updateSelection:function(){var e,t=this.get("selection"),a=wp.media.VcTeaserCustomImage.getData();""!==a&&-1!==a&&(e=wp.media.model.Attachment.get(a),e.fetch()),t.reset(e?[e]:[])}}),window.wp.media.VcTeaserCustomImage={getData:function(){return""},set:function(){return!1},frame:function(e){return this.element=e,this._frame?this._frame:(this._frame=wp.media({state:"vc_teaser-custom-image",states:[new wp.media.controller.VcTeaserCustomImage]}),this._frame.on("toolbar:create:vc_single-image",function(e){this.createSelectToolbar(e,{text:window.i18nLocale.set_image})},this._frame),this._frame.state("vc_teaser-custom-image").on("select",this.select),this._frame)},select:function(){var e=this.get("selection").single();wp.media.VcTeaserCustomImage.set(e?e:-1)}};var t={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g},a=Backbone.View.extend({el:e("#vc_teaser"),events:{"click #vc_teaser-checkbox":"toggle","change .vc_teaser-button":"updateList","click .vc_teaser-image-custom":"setImageMode","click .vc_teaser-image-featured":"setImageMode","click .vc_teaser_add_custom_image":"showMediaEditor","click .vc_teaser-text-control":"setTextMode","click .vc_link-control":"setLinkControl","keyup #vc_teaser-text-custom":"setCustomText"},controls:["title","image","text","link"],current_image_mode:"",featured_image_trigger:!1,custom_image_attributes:"",current_text_mode:"",custom_text:"",initialize:function(){_.bindAll(this,"save","parse","updateColorPicker","clearColorPicker","updateTitle","triggerFeaturedImageChanges","setCustomTeaserImage","getCustomTeaserImage"),_.extend(window.wp.media.VcTeaserCustomImage,{getData:this.getCustomTeaserImage,set:this.setCustomTeaserImage}),this.render()},render:function(){this.$contructor_container=this.$el.find(".vc_teaser-constructor"),this.$data_field=this.$el.find(".vc_teaser-data-field"),this.$bgcolor=this.$el.find(".vc_teaser-bgcolor"),this.$toolbar=this.$contructor_container.find(".vc_toolbar"),this.$spinner=this.$contructor_container.find(".vc_teaser_loading_block"),this.renderButtons(this.controls),this.$list=this.$contructor_container.find(".vc_teaser-list"),this.$list.sortable({update:this.save,handle:".vc_move",forcePlaceholderSize:!0,placeholder:"widgets-placeholder",over:function(e,t){t.placeholder.css({maxWidth:t.placeholder.parent().width()})}}),this.$contructor_container.find(".vc_teaser-bgcolor").wpColorPicker({change:this.updateColorPicker,clear:this.clearColorPicker}),_.isEmpty(this.$bgcolor.val())||this.$list.css("backgroundColor",this.$bgcolor.val()),this.$spinner.show(),_.delay(this.parse,200),this.toggle({currentTarget:"#vc_teaser-checkbox"})},renderButtons:function(a){_.each(a,function(a){var i=_.template(e("#vc_teaser-button").html(),{label:window.i18nVcTeaser[a+"_label"],value:a},t);this.$toolbar.append(i)},this)},toggle:function(t){var a=e(t.currentTarget);a.is(":checked")?this.$contructor_container.show():this.$contructor_container.hide()},updateColorPicker:function(e,t){var a=t?t.color.toString():"";this.$list.css("backgroundColor",a)},clearColorPicker:function(){this.$list.css("backgroundColor","")},updateList:function(t){var a=e(t.currentTarget),i={name:a.val(),link:"none"};"image"===i.name?i.mode="featured":"text"===i.name&&(i.mode="excerpt"),a.is(":checked")?this.createControl(i):(this.$list.find("[data-control="+i.name+"]").remove(),this.removeData(i),this.save())},setLinkControl:function(t){t.preventDefault();{var a=e(t.currentTarget),i=a.closest(".vc_link-controls");a.data("link")}i.find(".vc_active-link").removeClass("vc_active-link"),a.addClass("vc_active-link"),this.save()},createControl:function(a){var i={name:"",link:"none"},s=_.template(e("#vc_teaser-"+a.name).html(),_.extend(i,a),t);this.$list.append(s),this.updateContent(a)},removeData:function(t){"title"===t.name?e("#title").unbind("keyup.vcTeaserTitle"):"text"===t.name?this.current_text_mode="":"image"===t.name&&(this.current_image_mode="")},updateContent:function(t){"title"===t.name?(e("#title").bind("keyup.vcTeaserTitle",this.updateTitle).trigger("keyup.vcTeaserTitle"),this.save()):"image"===t.name?this.setImageMode(t.mode):"text"===t.name?this.setTextMode(t.mode):"link"===t.name&&this.save()},setTextMode:function(t){if(_.isObject(t)&&!_.isUndefined(t.currentTarget)){t.preventDefault();var a=e(t.currentTarget),i=a.data("mode")}else var i=t||"excerpt",a=e(".vc_teaser-text-"+i,this.$el);var s=e(".vc_text",this.$el);a.siblings(".vc_active").removeClass("vc_active"),a.addClass("vc_active"),i!==this.current_text_mode&&(s.removeClass("vc_text-"+this.current_image_mode).addClass("vc_text-"+i),this.current_text_mode=i,"excerpt"===i?s.html('<div class="vc_teaser-text-excerpt">'+this.getExcerpt()+"</div>"):"text"===i?s.html('<div class="vc_teaser-text-text"></div>').find(".vc_teaser-text-text").html(e("#content").val()):"custom"===i&&s.html('<textarea name="vc_teaser_text_custom" id="vc_teaser-text-custom"></textarea>').find("textarea").val(this.custom_text)),this.save()},setCustomText:function(){this.custom_text=e("#vc_teaser-text-custom").val(),this.save()},getExcerpt:function(){var t=e("#excerpt").val();return _.isEmpty(t)&&(t=e("#content").val().substring(0,150).replace(/\s+\S*$/,"")+" [...]"),t},setImageMode:function(t){if(_.isObject(t)&&!_.isUndefined(t.currentTarget)){t.preventDefault();var a=e(t.currentTarget),i=a.data("mode")}else var i=t||"featured",a=e(".vc_teaser-image-"+i,this.$el);a.siblings(".vc_active").removeClass("vc_active"),a.addClass("vc_active"),i!==this.current_image_mode&&(e(".vc_image",this.$el).removeClass("vc_image-"+this.current_image_mode).addClass("vc_image-"+i),this.current_image_mode=i,"featured"===i?(this.featured_image_trigger===!1&&(e(document).ajaxSuccess(this.triggerFeaturedImageChanges),this.featured_image_trigger=!0),this.setFeaturedImageBlock(e("#set-post-thumbnail").parent().html())):"custom"===i&&this.setCustomImageBlock()),this.save()},showMediaEditor:function(t){t.preventDefault(),window.wp.media.VcTeaserCustomImage.frame(e(".vc_teaser_add_custom_image",this.$el).get(0)).open("vc_editor")},getCustomTeaserImage:function(){return _.isObject(this.custom_image_attributes)&&!_.isUndefined(this.custom_image_attributes.id)?this.custom_image_attributes.id:""},setCustomTeaserImage:function(t){return _.isObject(t)&&(this.custom_image_attributes=t.attributes),_.isUndefined(this.custom_image_attributes.url)?(this.$spinner.show(),e.ajax({type:"POST",url:window.ajaxurl,data:{action:"wpb_single_image_src",content:this.custom_image_attributes.id,size:"large"},dataType:"html",context:this}).done(function(e){this.custom_image_attributes.url=e,this.appendCustomImageHtml()})):(this.appendCustomImageHtml(),this.save()),!1},appendCustomImageHtml:function(){this.$spinner.hide(),e(".vc_teaser-custom-image-view",this.$el).html(_.template(e("#vc_teaser-custom-image").html(),this.custom_image_attributes))},setCustomImageBlock:function(){var a=e(".vc_image",this.$el);a.html(_.template(e("#vc_teaser-custom-image-block").html(),{},t)),_.isObject(this.custom_image_attributes)&&!_.isUndefined(this.custom_image_attributes.id)?this.setCustomTeaserImage():this.save()},triggerFeaturedImageChanges:function(e,t,a){_.isString(a.data)&&a.data.match(/action=set\-post\-thumbnail/)&&this.setFeaturedImageBlock(_.isObject(t.responseJSON)?t.responseJSON.data:"")},setFeaturedImageBlock:function(t){var a=e(".vc_image",this.$el),i="";a.hasClass("vc_image-featured")&&(i=e(t).find("img").length?e(t).find("img"):e("<div>Featured image not set</div>"),e(".vc_image",this.$el).html("").append(i))},updateTitle:function(t){var a=e(t.currentTarget).val();_.isEmpty(a)&&(a='<span class="vc_empty">'+window.i18nVcTeaser.empty_title+"</span>"),e("#vc_teaser-title-control > span").html(a)},save:function(){var t=[],a=this;e(".vc_teaser-control",this.$el).each(function(){var i=e(this),s={name:i.data("control")};if("image"===s.name?s.image="featured"!==a.current_image_mode?a.getCustomTeaserImage():a.current_image_mode:"text"==s.name&&(s.mode=a.current_text_mode,"custom"===s.mode&&(s.text=a.custom_text)),i.find(".vc_link-controls").length){var r=e(".vc_active-link",i);r.length&&(s.link=r.data("link"))}t.push(s)}),this.$data_field.val(JSON.stringify(t))},parse:function(){var t=this.$data_field.val(),a=_.isEmpty(t)?[]:e.parseJSON(t);_.isEmpty(t)&&(a=[{link:"post",name:"title"},{name:"image"},{name:"text"}],this.$data_field.val(JSON.stringify(a))),_.each(a,function(t){if(_.isString(t.name)){{e(".vc_teaser-btn-"+t.name,this.$toolbar).prop("checked",!0)}"image"!=t.name||_.isUndefined(t.image)?"text"==t.name&&"custom"===t.mode&&(this.custom_text=t.text):"featured"!==t.image?(this.custom_image_attributes={id:t.image},t.mode="custom"):t.mode="featured",this.createControl(t),this.$spinner.hide()}},this),this.$spinner.hide()}});e(function(){e("#vc_teaser").is("div")&&(vc.teaser=new a)})}(window.jQuery);