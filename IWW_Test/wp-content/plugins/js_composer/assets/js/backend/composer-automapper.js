var vc_am={current_form:!1};!function(e){"use strict";_.extend(wp.shortcode.prototype,{taggedString:function(){var e='[<span class="vc_preview-tag">'+this.tag+"</span>";return _.each(this.attrs.numeric,function(t){e+=/\s/.test(t)?' <span class="vc_preview-param">"'+t+'"</span>':' <span class="vc_preview-param">'+t+"</span>"}),_.each(this.attrs.named,function(t,a){e+=' <span class="vc_preview-param">'+a+'="'+t+'"</span>'}),"single"===this.type?e+"]":"self-closing"===this.type?e+" /]":(e+="]",this.content&&(e+='<span class="vc_preview-content">'+this.content+"</span>"),e+'[/<span class="vc_preview-tag">'+this.tag+"</span>]")}}),wp.shortcode.atmPreview=function(e){return new wp.shortcode(e).taggedString()};var t,a=function(a,i){t&&(window.clearTimeout(t),e(".vc_settings-automapper").remove(),t=!1);var r=e('<div class="vc_atm-message updated'+(i?" vc_message-"+i:"")+'" style="display: none;"></div>');r.text(a),r.prependTo(e("#vc_settings-automapper")).fadeIn(500,function(){var t=e(this);window.setTimeout(function(){t.remove()},2e3)})},i={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g},r=function(e){return e=e.replace(/_|-/," "),e.charAt(0).toUpperCase()+e.slice(1)},n=function(t,a,i,r){r&&e(".vc_atm-message").remove();var n=e('<div class="vc_atm-message '+(a?a:"")+'" style="display: none;"></div>');return n.text(t),_.isUndefined(i)||window.setTimeout(function(){n.remove()},i),n},s=function(t,a){(_.isUndefined(a)||!a.length)&&(a=e(".tab_intro")),n(t,"error",void 0,!0).insertBefore(a).fadeIn(500)},c=window.ajaxurl+"?vc_action=automapper",o=function(t,a,i){var r;"create"===t?(a.set("id",window.vc_guid()),r={vc_action:"create",data:a.toJSON()}):r="update"===t?{vc_action:"update",id:a.get("id"),data:a.toJSON()}:"delete"===t?{vc_action:"delete",id:a.get("id")}:{vc_action:"read"},e.ajax({method:"POST",url:c,dataType:"json",data:_.extend(r,{action:"vc_automapper"}),context:this}).done(function(e){var r=a;e&&"read"===t&&(r=e),r?"read"===t&&i.success(r):i.error("Not found")}).error(function(){})},d=Backbone.Model.extend({defaults:function(){return{tag:"",name:"",category:"",description:"",params:[]}},sync:o}),m=Backbone.Collection.extend({model:d,sync:o});vc_am.shortcodes=new m;var l=(Backbone.View.extend({tagName:"li",className:"widget",events:{"click .vc_automapper-edit-btn":"edit","click h4, widget-action":"edit","click .vc_automapper-delete-btn":"clear"},template_html:e("#vc_automapper-item-tpl").html()||"<span>{{ tag }}</span>",initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.removeView)},render:function(){return this.$el.html(_.template(this.template_html,this.model.toJSON(),i)).attr("data-item-id",this.model.get("id")),this},edit:function(e){e&&e.preventDefault(),new h({model:this.model}).render()},clear:function(e){e&&e.preventDefault(),confirm(window.i18nLocaleVcAutomapper.are_you_sure_delete)&&this.model.destroy()},removeView:function(){this.$el.remove()}}),Backbone.View.extend({render:function(){return vc_am.current_form&&vc_am.current_form.close(),vc_am.current_form=this,this},getType:function(){return"form"},validate:function(e){var t=!1;if(!e.name)return window.i18nLocaleVcAutomapper.error_shortcode_name_is_required;if(!e.tag||!e.tag.match(/^\S+$/))return window.i18nLocaleVcAutomapper.error_enter_valid_shortcode_tag;var a=["param_name","heading","type"];return _.each(e.params,function(e){_.each(a,function(a){""===e[a]?t=window.i18nLocaleVcAutomapper.error_enter_required_fields:"param_name"!=a||e[a].match(/^[a-z0-9_]+$/g)||(t=window.i18nLocaleVcAutomapper.error_enter_required_fields)},this)},this),t||null},isValid:function(e){return this.validationError=this.validate(e),this.validationError?!1:!0},close:function(e){e&&e.preventDefault(),vc_am.current_form=!1,this.remove()}})),v=Backbone.View.extend({_$widget_title:!1,_$form_view:!1,edit_view:!1,tagName:"li",className:"widget",events:{"click .vc_automapper-edit-btn":"edit","click h4, .widget-action":"edit"},template_html:e("#vc_automapper-item-complex-tpl").html()||"<span>{{ tag }}</span>",header_template_html:'<h4>{{ name }}<span class="in-widget-title"></span></h4>',initialize:function(){_.bindAll(this,"removeEditForm"),this.listenTo(this.model,"destroy",this.removeView),this.model.view=this},render:function(){return this.$el.html(_.template(this.template_html,this.model.toJSON(),i)).attr("data-item-id",this.model.get("id")),this},renderTitle:function(){this.$widgetTitle().html(_.template(this.header_template_html,this.model.toJSON(),i))},edit:function(e){return e&&e.preventDefault(),this.$editForm().is(":animated")?!1:(this.$el.addClass("vc_opened"),void(this.edit_view?this.close():this.edit_view=new u({model:this.model}).render()))},$widgetTitle:function(){return this._$widget_title||(this._$widget_title=this.$el.find(".widget-title")),this._$widget_title},$editForm:function(){return this._$edit_form||(this._$edit_form=this.$el.find(".widget-inside")),this._$edit_form},removeEditForm:function(){this.edit_view&&this.edit_view.remove(),this.edit_view=!1},beforeSave:function(){this.$el.find("#vc_atm-name").val(e("#vc_atm-header-name").val())},close:function(){vc_am.current_form=!1,this.$el.removeClass("vc_opened"),this.renderTitle(),this.$editForm().slideUp(200),this.removeEditForm()},clear:function(e){e&&e.preventDefault(),this.model.destroy()},removeView:function(){this.remove()}}),p=l.extend({className:"vc_add-form-atm",template_html:e("#vc_automapper-add-form-tpl").html(),events:{"click #vc_atm-parse-string":"parseShortcode","click .vc_atm-cancel":"close"},getType:function(){return"create"},render:function(){return p.__super__.render.call(this),this.$el.html(_.template(this.template_html,{},i)),this.$el.insertAfter(".vc_automapper-toolbar"),this},parseShortcode:function(t){var i,n,c,o,d=[];return t&&t.preventDefault&&t.preventDefault(),i=e("#vc_atm-shortcode-string").val(),_.isEmpty(i)?(this.$el.addClass("form-invalid"),s(window.i18nLocaleVcAutomapper.error_enter_valid_shortcode,this.$el),!1):(n=i.match(vc_regexp_shortcode()))?(o=wp.shortcode.attrs(n[3]),_.each(o.named,function(e,t){d.push({param_name:t,type:"textfield",heading:r(t),description:"Example: "+e,value:e})},this),n[5]&&d.push({param_name:"content",type:"textarea",heading:"Content",description:"",value:n[5]}),c={tag:n[2],name:r(n[2]),category:window.i18nLocaleVcAutomapper.my_shortcodes_category,params:d},void(this.isValid(c)?(vc_am.shortcodes.create(c),a(window.i18nLocaleVcAutomapper.new_shortcode_mapped,"success"),e(".vc_atm-message").remove(),vc_am.shortcodes.last().view.edit()):(this.$el.addClass("form-invalid"),s(this.validationError)))):(this.$el.addClass("form-invalid"),s(window.i18nLocaleVcAutomapper.error_enter_valid_shortcode,this.$el),!1)}}),h=l.extend({className:"vc_edit-form",active_preview:!1,events:{"click #vc_atm-save":"save","click .vc_atm-cancel":"close","click .vc_atm-delete":"clear","click #vc_atm-add-param":"addParam","click .vc_delete-param":"deleteParam","change #vc_atm-is-container":"setContentParam","keyup .vc_param-name, .vc_param-value, #vc_atm-tag":"setPreview","focus #vc_atm-tag":"setTagFieldActive","focus .vc_params input, .vc_params textarea":"setParamFieldActive","focus .vc_param.vc_content input, .vc_param.vc_content textarea":"setContentParamFieldActive","blur #vc_atm-tag, vc_param input":"unsetFieldActive",'change .vc_param-field [name="type"]':"changeParamType"},"new":!1,template_html:e("#vc_automapper-form-tpl").html(),param_template_html:e("#vc_atm-form-param-tpl").html(),getType:function(){return"edit"},render:function(){return h.__super__.render.call(this),this.$el.html(_.template(this.template_html,this.model.toJSON(),i)),this.$el.insertAfter(e("[data-item-id="+this.model.id+"]").hide()),this.addAllParams(),this},changeParamType:function(t){var a,i;a=e(t.currentTarget),i=a.parents(".vc_fields"),"hidden"===a.val()?(i.find('[name="heading"]').attr("disabled",!0),i.find('[name="description"]').attr("disabled",!0)):(i.find('[name="heading"]').attr("disabled",!1),i.find('[name="description"]').attr("disabled",!1))},setTagFieldActive:function(){this.active_preview&&e(this.active_preview).removeClass("vc_active"),this.active_preview="#vc_shortcode-preview .vc_preview-tag",e(this.active_preview).addClass("vc_active")},setParamFieldActive:function(t){var a=e(t.currentTarget),i=a.parents(".vc_param:first").index();this.active_preview&&e(this.active_preview).removeClass("vc_active"),this.active_preview="#vc_shortcode-preview .vc_preview-param:eq("+i+")",e(this.active_preview).addClass("vc_active")},setContentParamFieldActive:function(){this.active_preview&&e(this.active_preview).removeClass("vc_active"),this.active_preview="#vc_shortcode-preview .vc_preview-content",e(this.active_preview).addClass("vc_active")},unsetFieldActive:function(){e(this.active_preview).removeClass("vc_active"),this.active_preview=!1},escapeParam:function(e){return e&&e.replace(/"/g,"``")},getPreview:function(e){var t=e.params,a=!1,i={};return _.each(t,function(e){"content"!==e.param_name?i[e.param_name]=this.escapeParam(e.value):a=e.value},this),wp.shortcode.atmPreview({tag:e.tag,attrs:i,content:a,type:a===!1?"single":""})},setPreview:function(){var t={params:this.getParams(),tag:e("#vc_atm-tag").val()};e("#vc_shortcode-preview").html(this.getPreview(t)),this.active_preview&&e(this.active_preview).addClass("vc_active")},save:function(t){t&&t.preventDefault&&t.preventDefault(),this.$el.find(".vc_error").removeClass("vc_error");var i={tag:e("#vc_atm-tag").val(),name:e("#vc_atm-name").val(),category:e("#vc_atm-category").val(),description:e("#vc_atm-description").val(),params:this.getParams()};this.isValid(i)?(this.model.save(i),a(window.i18nLocaleVcAutomapper.shortcode_updated,"success"),this.close()):s(this.validationError,this.$el.find("#vc_atm-save"))},validate:function(t){e(".vc_error,.form-invalid").removeClass("vc_error form-invalid");var a=!1,i={};if(!t.name)return e("#vc_atm-name").addClass("vc_error"),e("#vc_atm-header-name").parent().addClass("form-invalid"),window.i18nLocaleVcAutomapper.error_shortcode_name_is_required;if(!t.tag||!t.tag.match(/^\S+$/))return e("#vc_atm-tag").addClass("vc_error").parent().addClass("form-invalid"),window.i18nLocaleVcAutomapper.error_enter_valid_shortcode_tag;var r=["param_name","heading","type"];return _.each(t.params,function(t,n){var s=e("#vc_atm-params-list [name=param_name]:eq("+n+")");return"content"!==t.param_name||s.data("system")?(_.isBoolean(i[t.param_name])&&1==i[t.param_name]&&(s.addClass("vc_error"),s.closest(".vc_param-field").addClass("form-invalid"),a||(a=window.i18nLocaleVcAutomapper.error_param_already_exists.replace(/\%s/,t.param_name))),i[t.param_name]=!0,void _.each(r,function(i){"hidden"!==t.type&&""===t[i]||"hidden"===t.type&&"heading"!==i&&""===t[i]?(e("#vc_atm-params-list [name="+i+"]:eq("+n+")").addClass("vc_error").closest(".vc_param-field").addClass("form-invalid"),a||(a=window.i18nLocaleVcAutomapper.error_enter_required_fields)):"param_name"!=i||t[i].match(/^[a-z0-9_]+$/g)||(s.addClass("vc_error").closest(".vc_param-field").addClass("form-invalid"),a||(a=window.i18nLocaleVcAutomapper.error_wrong_param_name))},this)):(a=window.i18nLocaleVcAutomapper.error_content_param_not_manually,s.addClass("vc_error"),void s.closest(".vc_param-field").addClass("form-invalid"))},this),a||null},setContentParam:function(t){var a=e(t.currentTarget);a.is(":checked")?(this.addParamField({type:"textarea",heading:"Content",description:"",param_name:"content",value:""}),this.setParamSorting()):this.removeParamField("content"),this.setPreview()},addAllParams:function(){e("#vc_atm-params-list").empty(),_.each(this.model.get("params"),function(t){this.addParamField(t),"content"===t.param_name&&e("#vc_atm-is-container").prop("checked",!0)},this),this.setParamSorting()},getParams:function(){var t=[];return _.each(e(".vc_param"),function(a){var i=e(a);t.push({param_name:i.find("[name=param_name]").val(),type:i.find("[name=type]").val(),description:i.find("[name=description]").val(),heading:i.find("[name=heading]").val(),value:i.find("[name=value]").val()})},this),t},addParam:function(e){e&&e.preventDefault(),this.addParamField({type:"",heading:"",description:"",param_name:"",value:""}),this.setPreview()},removeParamField:function(t){e('.vc_param-name[value="'+t+'"]').parents(".vc_param").remove()},addParamField:function(t){var a=e('<div class="vc_param wpb_vc_row'+("content"===t.param_name?" vc_content":"")+'"/>').appendTo("#vc_atm-params-list");a.html(_.template(this.param_template_html,t,i))},setParamSorting:function(){e("#vc_atm-params-list").sortable({items:"> .vc_param",tolerance:"pointer",handle:".vc_move-param",update:this.setPreview,placeholder:"vc_sortable-placeholder"})},deleteParam:function(t){var a;t&&t.preventDefault(),confirm(window.i18nLocaleVcAutomapper.are_you_sure_delete_param)&&(a=e(t.currentTarget),a.parents(".vc_param").remove(),this.setPreview())},close:function(t){t&&t.preventDefault(),this.model&&e("[data-item-id="+this.model.get("id")+"]").show(),vc_am.current_form=!1,e(".vc_atm-message").remove(),this.remove()},clear:function(e){e&&e.preventDefault(),confirm(window.i18nLocaleVcAutomapper.are_you_sure_delete)&&(this.model.destroy(),this.close())}}),u=h.extend({template_html:e("#vc_automapper-form-tpl").html(),getType:function(){return"edit"},initialize:function(){_.bindAll(this,"setPreview")},render:function(){var t,a=this.model.view;return t=this.model.get("params"),h.__super__.render.call(this),this.$el.html(_.template(this.template_html,_.extend({shortcode_preview:this.getPreview(this.model.toJSON())},this.model.toJSON()),i)),this.$el.appendTo(a.$editForm()),a.$widgetTitle().html('<span class="vc_atm-header"><input type="text" name="name" value="" id="vc_atm-header-name" class="vc_header-name"></span><span class="in-widget-title"></span>'),e("#vc_atm-header-name").val(this.model.get("name")),this.addAllParams(),a.$editForm().slideDown(),this},save:function(e){e&&e.preventDefault(),this.model.view.beforeSave(),u.__super__.save.call(this)},close:function(e){e&&e.preventDefault(),vc_am.current_form=!1,this.model.view.close()},clear:function(e){e&&e.preventDefault(),confirm(window.i18nLocaleVcAutomapper.are_you_sure_delete)&&(this.model.view.clear(),this.remove())}}),f=Backbone.View.extend({events:{"click #vc_automapper-add-btn":"create",submit:"formSubmit"},className:"vc_atm-form",addFormView:!1,initialize:function(){this.listenTo(vc_am.shortcodes,"add",this.addOne),this.listenTo(vc_am.shortcodes,"reset",this.addAll),this.listenTo(vc_am.shortcodes,"all",this.render),this.$list=e(".vc_automapper-list"),vc_am.shortcodes.fetch()},formSubmit:function(t){if(t&&t.preventDefault&&t.preventDefault(),_.isObject(t)&&this.addFormView&&!_.isEmpty(t.currentTarget)&&!_.isEmpty(t.currentTarget[0])){var a,i;a=t.currentTarget[0],i=e(a),i.is("#vc_atm-shortcode-string")&&this.addFormView.parseShortcode()}},addAll:function(e){e.each(function(e){this.addOne(e)},this)},addOne:function(e){var t=new v({model:e});this.$list.append(t.render().el)},create:function(e){e&&e.preventDefault&&e.preventDefault(),vc_am.current_form&&"create"===vc_am.current_form.getType()||(this.addFormView=(new p).render())},render:function(){}});new f({el:e("#vc_settings-automapper")})}(window.jQuery);